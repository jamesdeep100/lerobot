# Cursor-Native Experiment Protocol (CNEP) v1.1
# LeRobot 模型训练协同实验规范

## 规范文件结构

```
lerobot/
├── .cursorrules              # 核心规范（本文件）
├── experiment_registry.md    # 实验记录表（参数历史、SOTA）
├── scripts/
│   ├── run_batch.sh          # 多机调度脚本
│   ├── train_act.sh          # ACT 训练脚本
│   ├── train_diffusion.sh    # Diffusion 训练脚本
│   └── eval_model.py         # 评估脚本
└── experiments/              # 实验归档目录
```

## 核心原则

你是一个**执行者**，不是决策者。所有实验参数必须有据可查，严禁凭空创造。
**每个实验必须完整可追溯**：代码、配置、结果缺一不可。

## 强制行为规范

### 1. 启动任何实验前，必须执行

```
READ experiment_registry.md  # 了解当前 SOTA 和历史参数
READ experiments/<parent_exp>/config.yaml  # 基于父实验配置
```

### 2. 参数修改规则

- **严禁**：凭记忆设置参数
- **必须**：基于 `experiment_registry.md` 中记录的最佳配置
- **必须**：明确说明"基于 exp_XXX 修改了哪些参数"

### 3. 创建新实验时

1. 在 `experiments/` 下创建 `exp_NNN_name/` 目录
2. 从 `scripts/` 复制训练脚本到实验目录
3. 修改复制后的脚本，保持 `scripts/` 下的原始脚本不变
4. 生成 `config.yaml` 记录所有参数
5. 更新 `experiment_registry.md` 添加新行

**或者使用批量调度（推荐）：** 通过 `run_batch.sh` 启动，参数通过命令行传递，脚本会自动保存代码快照。

### 4. 实验目录结构（完整归档）

```
experiments/exp_NNN_name/
├── config.yaml          # 完整参数配置
├── run_train.sh         # 训练启动脚本（从模板复制）
├── run_eval.sh          # 评估启动脚本（从模板复制）
├── train_snapshot.py    # 训练代码快照（训练时自动复制）
├── eval_snapshot.py     # 评估代码快照（评估时自动复制）
├── train.log            # 训练日志
├── eval.log             # 评估日志
├── eval_result.json     # 评估结果
├── model.safetensors    # 模型权重
├── notes.md             # 实验结论
└── metadata.yaml        # 环境元数据（见下）
```

### 5. 实验元数据要求 (metadata.yaml)

每个实验必须记录以下信息：

```yaml
# metadata.yaml
experiment:
  id: exp_NNN_name
  created: 2026-01-12 17:00:00
  parent: exp_XXX  # 父实验

code:
  commit_hash: abc123def  # 当前 git commit
  branch: main
  has_uncommitted: false
  experiment_branch: exp/exp_NNN_name  # 实验专属分支（训练后创建）

environment:
  python: 3.10.x
  torch: 2.x.x
  lerobot: x.x.x
  cuda: 12.x
  gpu: RTX 5090 / RTX 3060 Ti

training:
  start_time: 2026-01-12 17:00:00
  end_time: 2026-01-12 20:00:00
  duration_seconds: 10800
  final_loss: 0.xxx

evaluation:
  n_episodes: 50
  success_rate: xx.x%
  avg_sum_reward: xx.xx
  avg_max_reward: xx.xx
```

### 6. 代码归档规则

**训练完成后，必须执行以下操作：**

1. 创建实验专属分支: `git branch exp/exp_NNN_name`
2. 在该分支上提交当前代码状态
3. 记录 commit hash 到 `metadata.yaml`

这确保每个实验的代码都可以完整追溯和复现。

```bash
# 训练完成后自动执行（在模板脚本中）
git branch exp/${EXP_NAME} 2>/dev/null || true
git stash
git checkout exp/${EXP_NAME}
git add -A
git commit -m "[exp] ${EXP_NAME} - 训练完成快照"
git checkout -
git stash pop 2>/dev/null || true
```

## 关键参数参考表（从历史实验中提取）

### Diffusion Policy (PushT)

| 参数 | 默认值 | 最佳值 | 说明 |
|------|--------|--------|------|
| training_steps | 5000 | 100000 | 训练步数 |
| horizon | 16 | 32 | 预测序列长度 |
| n_action_steps | 8 | 8 | 执行动作数 |
| batch_size | 32 | 32 | 批量大小 |
| down_dims | [256,512,1024] | [256,512,1024] | U-Net 维度 |

### ACT (PushT)

| 参数 | 默认值 | 当前最佳 | 说明 |
|------|--------|----------|------|
| training_steps | 5000 | 20000+ | 训练步数 |
| chunk_size | 10 | 10 | Action Chunk 大小 |
| n_action_steps | 10 | 10 | 每次执行动作数 |
| dim_model | 512 | 1024 | Transformer 维度 |
| n_decoder_layers | 1 | 4 | Decoder 层数 |
| batch_size | 32 | 32 | 批量大小 |

## 历史教训记录

### 2026-01-12: chunk_size 错误导致实验失败

- **错误**: 将 ACT 的 `chunk_size` 从 10 改为 100
- **后果**: 10 个实验全部失败，成功率 0%
- **原因**: chunk_size=100 意味着预测未来 10 秒动作，难度过大
- **教训**: 修改关键参数前必须查阅历史最佳配置

## 多机批量实验规范

### 7. 所有实验必须通过批量调度系统启动

**严禁**直接运行单个训练脚本。所有实验必须通过 `scripts/run_batch.sh` 统一调度。

### 8. 批量实验目录结构

```
experiments/batch_MMDD_HHMM/
├── config.yaml          # 批次配置（从模板复制）
├── batch.log            # 批次总日志
├── exp_001_name/        # 子实验目录
│   ├── config.yaml
│   ├── metadata.yaml
│   ├── ...
├── exp_002_name/
│   └── ...
└── summary.md           # 批次总结（所有实验完成后生成）
```

### 9. 创建批量实验流程

```bash
cd ~/ai_projects/lerobot
source scripts/run_batch.sh

# 添加实验（基于 experiment_registry.md 中的最佳配置）
add_laptop_exp "act" "exp_name" "--steps 50000 --dim_model 1024 --n_decoder_layers 4 --chunk_size 10 --eval"
add_desktop_exp "diffusion" "exp_name" "--steps 100000 --horizon 32 --eval"

# 启动
run_all
```

### 10. 添加实验的参数格式

```bash
add_laptop_exp "<policy>" "<name>" "<options>"
add_desktop_exp "<policy>" "<name>" "<options>"

# policy: act 或 diffusion
# name: 实验名称（会自动加上时间戳前缀）
# options: 训练参数，从 experiment_registry.md 查找最佳值
```

### 11. 机器配置

| 机器 | GPU | Tailscale IP | 用途 |
|------|-----|--------------|------|
| 笔记本 | RTX 5090 | localhost | Diffusion 首选 |
| 台式机 | RTX 3060 Ti | 100.67.100.43 | ACT 首选 |

## 检查清单（每次起实验前）

- [ ] 已读取 `experiment_registry.md`
- [ ] 已确认父实验及其参数
- [ ] 关键参数与历史最佳一致（或有明确实验目的）
- [ ] 创建了批次目录和 config.yaml
- [ ] 参数与 experiment_registry.md 中最佳配置一致
- [ ] 通过 `run_batch.sh` 启动（不是直接运行脚本）
- [ ] 更新了 experiment_registry.md

## 禁止行为

1. ❌ 不查阅历史就设置参数
2. ❌ 不经确认随意修改 `scripts/` 下的脚本
3. ❌ 在原有实验目录上修改配置重跑
4. ❌ 使用"默认值"而不是"历史最佳值"
5. ❌ 批量起实验时使用未经验证的参数组合
6. ❌ 绕过 `run_batch.sh` 直接运行训练脚本
7. ❌ 批次配置中不指定 parent 父实验
