# Cursor-Native Experiment Protocol (CNEP) v1.2
# LeRobot 模型训练协同实验规范

## 规范文件结构

```
~/ai_projects/
├── lerobot/                      # 代码仓库（保持纯净）
│   ├── .cursorrules              # 核心规范（本文件）
│   └── scripts/
│       ├── run_batch.sh          # 多机调度脚本
│       ├── train_act.sh          # ACT 训练脚本
│       ├── train_diffusion.sh    # Diffusion 训练脚本
│       └── eval_model.py         # 评估脚本
│
└── lerobot-experiments/          # 实验结果仓库（独立）
    ├── leaderboard.md    # 实验记录表（参数历史、SOTA）
    ├── YYYYMMDD_HHMM_batch/      # 批次目录
    │   ├── batch.md              # 批次日志
    │   ├── laptop.sh/log         # 笔记本执行脚本/日志
    │   ├── desktop.sh/log        # 台式机执行脚本/日志
    │   ├── YYYYMMDD_HHMM_exp1/   # 子实验1
    │   └── YYYYMMDD_HHMM_exp2/   # 子实验2
    └── ...
```

## 核心原则

你是一个**执行者**，不是决策者。所有实验参数必须有据可查，严禁凭空创造。
**每个实验必须完整可追溯**：代码、配置、结果缺一不可。

## 强制行为规范

### 1. 启动任何实验前，必须执行

```
READ leaderboard.md  # 了解当前 SOTA 和历史参数
```

### 2. 参数修改规则

- **严禁**：凭记忆设置参数
- **必须**：基于 `leaderboard.md` 中记录的最佳配置
- **必须**：明确说明"基于 exp_XXX 修改了哪些参数"

### 3. 启动实验方式

**通过 `run_batch.sh` 统一调度（唯一入口）：**

```bash
cd ~/ai_projects/lerobot
source scripts/run_batch.sh

# 添加实验（参数从 leaderboard.md 查找）
add_laptop_exp "act" "exp_name" "--steps 50000 --dim_model 1024 --chunk_size 10 --eval"
add_desktop_exp "diffusion" "exp_name" "--steps 100000 --horizon 32 --eval"

# 启动
run_all
```

脚本会自动：
- 创建批次目录 `lerobot-experiments/YYYYMMDD_HHMM_batch/`
- 在批次目录下创建子实验目录
- 保存 config.yaml、metadata.yaml
- 保存代码快照 train_snapshot.py、eval_snapshot.py
- 创建 git 分支 `exp/YYYYMMDD_HHMM_exp_name`

### 4. 批次目录结构

```
lerobot-experiments/YYYYMMDD_HHMM_batch/
├── batch.md              # 批次日志（实验清单、时间线）
├── laptop.sh             # 笔记本执行脚本
├── laptop.log            # 笔记本运行日志
├── laptop.pid            # 笔记本进程 PID
├── desktop.sh            # 台式机执行脚本
├── desktop.log           # 台式机运行日志
├── YYYYMMDD_HHMM_exp1/   # 子实验1
│   ├── config.yaml       # 参数配置
│   ├── metadata.yaml     # 环境元数据
│   ├── train_snapshot.py # 训练代码快照
│   ├── eval_snapshot.py  # 评估代码快照
│   ├── train.log         # 训练日志
│   ├── eval.log          # 评估日志
│   ├── eval_results.json # 评估结果
│   └── model.safetensors # 模型权重
└── YYYYMMDD_HHMM_exp2/   # 子实验2
    └── ...
```

### 5. 代码复现

每个实验的代码自动提交到 lerobot 代码仓库的独立 git 分支：

```bash
cd ~/ai_projects/lerobot

# 查看实验分支
git branch | grep exp/

# 复现某个实验
git checkout exp/YYYYMMDD_HHMM_exp_name
# 此时代码状态与训练时完全一致
```

### 6. 实验元数据 (metadata.yaml)

训练脚本自动生成，包含：
- 实验ID、父实验、创建时间
- Git commit hash、分支、是否有未提交代码
- Python/PyTorch/CUDA 版本、GPU 型号
- 训练时长、最终 loss
- 模型参数配置

## 关键参数参考表

### Diffusion Policy (PushT)

| 参数 | 默认值 | 最佳值 | 说明 |
|------|--------|--------|------|
| training_steps | 5000 | 100000 | 训练步数 |
| horizon | 16 | 32 | 预测序列长度 |
| n_action_steps | 8 | 8 | 执行动作数 |
| batch_size | 32 | 32 | 批量大小 |

### ACT (PushT)

| 参数 | 默认值 | 当前最佳 | 说明 |
|------|--------|----------|------|
| training_steps | 5000 | 20000+ | 训练步数 |
| chunk_size | 10 | 10 | Action Chunk 大小 |
| n_action_steps | 10 | 10 | 每次执行动作数 |
| dim_model | 512 | 1024 | Transformer 维度 |
| n_decoder_layers | 1 | 4 | Decoder 层数 |

## 历史教训记录

### 2026-01-12: Shell 环境隔离导致变量丢失

- **错误**: 在不同命令中分别执行 `source run_batch.sh`、`add_laptop_exp`、`run_all`
- **后果**: 每次运行新命令时 shell 环境隔离，`BATCH_TIMESTAMP`、`BATCH_DIR`、`LAPTOP_EXPS` 等变量丢失
- **解决方案**: **必须在同一个命令中完成所有操作**

```bash
# ✅ 正确做法：在同一个命令中完成
cd ~/ai_projects/lerobot
source scripts/run_batch.sh
set_batch_purpose "实验目的描述"
add_laptop_exp "act" "exp_name" "--steps 50000" "子实验目的"
run_all

# ❌ 错误做法：分开执行（变量会丢失）
# 命令1: source scripts/run_batch.sh
# 命令2: add_laptop_exp ...  ← BATCH_TIMESTAMP 丢失！
# 命令3: run_all             ← LAPTOP_EXPS 丢失！
```

### 2026-01-12: chunk_size 错误导致实验失败

- **错误**: 将 ACT 的 `chunk_size` 从 10 改为 100
- **后果**: 10 个实验全部失败，成功率 0%
- **教训**: 修改关键参数前必须查阅 leaderboard.md

## 多机配置

| 机器 | GPU | Tailscale IP | 用途 |
|------|-----|--------------|------|
| 笔记本 | RTX 5090 | localhost | Diffusion 首选 |
| 台式机 | RTX 3060 Ti | 100.67.100.43 | ACT 首选 |

## 检查清单

- [ ] 已读取 `leaderboard.md`
- [ ] 参数基于历史最佳配置
- [ ] 通过 `run_batch.sh` 启动
- [ ] 实验完成后更新 `leaderboard.md`

## 禁止行为

1. ❌ 不查阅历史就设置参数
2. ❌ 凭空创造参数值
3. ❌ 绕过 `run_batch.sh` 直接运行训练脚本
4. ❌ 在原有实验目录上修改配置重跑
